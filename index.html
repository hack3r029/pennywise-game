<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Vem Flutuar: Ultimate Fix üéà</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
  html, body {
    margin: 0;
    height: 100%;
    background-color: #05000a;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    touch-action: none;
    font-family: 'Press Start 2P', monospace;
    user-select: none;
    -webkit-user-select: none;
    color: white;
  }

  #game-wrapper {
    position: relative;
    box-shadow: 0 0 50px rgba(100, 0, 0, 0.4);
    border: 2px solid #333;
    overflow: hidden;
    background: #000;
  }

  canvas {
    display: block;
    background: #0d0616;
    image-rendering: pixelated;
    width: 100%;
    height: 100%;
  }

  /* Scanlines e Efeitos */
  .overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.1) 50%);
    background-size: 100% 4px;
    pointer-events: none;
    z-index: 10;
  }

  /* Mensagem de Erro (caso ocorra) */
  #error-msg {
    display: none;
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    background: rgba(0,0,0,0.9);
    padding: 20px;
    border: 1px solid red;
    z-index: 999;
    font-size: 10px;
  }
</style>
</head>

<body>

<div id="game-wrapper">
  <canvas id="game"></canvas>
  <div class="overlay"></div>
</div>

<div id="error-msg">
  ERRO CR√çTICO<br>
  <button onclick="localStorage.clear(); location.reload();" style="margin-top:10px; padding:10px;">RESETAR DADOS</button>
</div>

<script>
window.onerror = function(msg, url, line) {
  const errDiv = document.getElementById("error-msg");
  errDiv.style.display = "block";
  errDiv.innerHTML += `<br>Linha ${line}: ${msg}`;
  return false;
};

try {
/**
 * VEM FLUTUAR: SAFETY VERSION
 */

// ================= CONFIG CANVAS =================
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d", { alpha: false });
const GAME_W = 240;
const GAME_H = 360;

function resize() {
  const winW = window.innerWidth;
  const winH = window.innerHeight;
  const scale = Math.min(winW / GAME_W, winH / GAME_H);
  
  const finalW = Math.floor(GAME_W * scale);
  const finalH = Math.floor(GAME_H * scale);

  const wrapper = document.getElementById("game-wrapper");
  wrapper.style.width = finalW + "px";
  wrapper.style.height = finalH + "px";
  
  canvas.width = GAME_W;
  canvas.height = GAME_H;
}
window.addEventListener('resize', resize);
resize();

// ================= FUN√á√ïES AUXILIARES SEGURAS =================

// Substituto seguro para roundRect que funciona em todos navegadores
function drawRoundRect(ctx, x, y, w, h, radius) {
  if (w < 2 * radius) radius = w / 2;
  if (h < 2 * radius) radius = h / 2;
  ctx.beginPath();
  ctx.moveTo(x + radius, y);
  ctx.arcTo(x + w, y, x + w, y + h, radius);
  ctx.arcTo(x + w, y + h, x, y + h, radius);
  ctx.arcTo(x, y + h, x, y, radius);
  ctx.arcTo(x, y, x + w, y, radius);
  ctx.closePath();
  ctx.fill();
}

// Carregamento Seguro de Dados
function loadSafe(key, def) {
  try {
    const item = localStorage.getItem(key);
    return item ? JSON.parse(item) : def;
  } catch (e) {
    console.log("Erro ao carregar dados, resetando: " + key);
    return def;
  }
}

// ================= ESTADO DO JOGO =================
const DB = {
  balloons: [
    {id:"red", name:"Sangue", price:0, color:"#d00"},
    {id:"blue", name:"Noturno", price:50, color:"#2ad"},
    {id:"green", name:"T√≥xico", price:100, color:"#0f0"},
    {id:"gold", name:"Ouro", price:300, color:"#ffd700"},
    {id:"void", name:"Vazio", price:500, color:"#304"}
  ],
  skins: [
    {id:"classic", name:"Palha√ßo", price:0},
    {id:"zombie", name:"Zumbi", price:200},
    {id:"shadow", name:"Sombra", price:450},
    {id:"mime", name:"M√≠mico", price:600}
  ],
  skills: [
    {id:"magnet", name:"√çm√£", desc:"Puxa bal√µes", price:500},
    {id:"shield", name:"Escudo", desc:"Protege 1x", price:800},
    {id:"doublejump", name:"Pulo Duplo", desc:"Pulo no ar", price:1000}
  ]
};

let SAVES = {
  coins: parseInt(localStorage.getItem("coins")) || 0,
  best: parseInt(localStorage.getItem("best")) || 0,
  balloons: loadSafe("myBalloons", ["red"]),
  skins: loadSafe("mySkins", ["classic"]),
  skills: loadSafe("mySkills", []),
  equipped: {
    balloon: localStorage.getItem("eqBalloon") || "red",
    skin: localStorage.getItem("eqSkin") || "classic",
    skill: localStorage.getItem("eqSkill") || null
  }
};

function saveData() {
  localStorage.setItem("coins", SAVES.coins);
  localStorage.setItem("best", SAVES.best);
  localStorage.setItem("myBalloons", JSON.stringify(SAVES.balloons));
  localStorage.setItem("mySkins", JSON.stringify(SAVES.skins));
  localStorage.setItem("mySkills", JSON.stringify(SAVES.skills));
  localStorage.setItem("eqBalloon", SAVES.equipped.balloon);
  localStorage.setItem("eqSkin", SAVES.equipped.skin);
  localStorage.setItem("eqSkill", SAVES.equipped.skill);
}

// Vari√°veis de Jogo
let state = "MENU";
let frames = 0;
let score = 0;
let speed = 1.0;
let shopTab = "balloons";

// ================= √ÅUDIO =================
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let actx = null;

function initAudio() {
  if (!actx && AudioCtx) actx = new AudioCtx();
  if (actx && actx.state === 'suspended') actx.resume();
}

function sfx(type) {
  if (!actx) return;
  const osc = actx.createOscillator();
  const g = actx.createGain();
  osc.connect(g); g.connect(actx.destination);
  const t = actx.currentTime;

  if (type==="jump") {
    osc.frequency.setValueAtTime(150, t);
    osc.frequency.linearRampToValueAtTime(300, t+0.1);
    g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.1);
    osc.start(t); osc.stop(t+0.1);
  } else if (type==="coin") {
    osc.frequency.setValueAtTime(1000, t);
    osc.frequency.setValueAtTime(1500, t+0.1);
    g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.15);
    osc.start(t); osc.stop(t+0.15);
  } else if (type==="die") {
    osc.type = "sawtooth";
    osc.frequency.setValueAtTime(150, t);
    osc.frequency.exponentialRampToValueAtTime(40, t+0.4);
    g.gain.setValueAtTime(0.2, t); g.gain.linearRampToValueAtTime(0, t+0.4);
    osc.start(t); osc.stop(t+0.4);
  }
}

// ================= CLASSES =================
class Player {
  constructor() {
    this.x = 50; this.y = 100;
    this.w = 14; this.h = 22;
    this.vy = 0;
    this.gravity = 0.12;     // Gravidade suave
    this.jumpForce = -2.5;   // Pulo suave
    this.jumps = 0;
    this.hasShield = false;
  }
  
  reset() {
    this.y = 100; this.vy = 0;
    this.hasShield = (SAVES.equipped.skill === "shield");
    this.jumps = (SAVES.equipped.skill === "doublejump") ? 1 : 0;
  }
  
  update() {
    this.vy += this.gravity;
    this.y += this.vy;
    if (this.y > GAME_H - 24) gameOver();
    if (this.y < 0) { this.y = 0; this.vy = 0; }
  }
  
  jump() {
    initAudio();
    if (this.vy < 0 && SAVES.equipped.skill === "doublejump" && this.jumps > 0) {
      this.vy = this.jumpForce;
      this.jumps--;
      sfx("jump");
      createParticles(this.x+7, this.y+20, "#fff", 4);
    } else if (state === "GAME") {
      this.vy = this.jumpForce;
      sfx("jump");
    }
  }
  
  draw() {
    drawSkin(Math.floor(this.x), Math.floor(this.y), SAVES.equipped.skin);
    if (this.hasShield) {
      ctx.strokeStyle = `rgba(0,255,255,${0.5+Math.sin(frames*0.2)*0.2})`;
      ctx.beginPath(); ctx.arc(this.x+7, this.y+11, 16, 0, Math.PI*2); ctx.stroke();
    }
  }
}

const player = new Player();
let entities = [];
let particles = [];

// ================= LOOP LOGIC =================
function spawn() {
  // Bal√£o
  if (frames % 60 === 0) {
    let b = {
      x: GAME_W+10, y: 40 + Math.random()*(GAME_H-120),
      type: "balloon", w: 10, h: 12, bob: Math.random()*10,
      color: DB.balloons.find(x=>x.id===SAVES.equipped.balloon)?.color || "#d00"
    };
    entities.push(b);
  }
  
  // Serra
  let diff = 180 - (score * 2);
  if (diff < 80) diff = 80;
  if (frames % diff === 0) {
    let isTop = Math.random() > 0.5;
    let s = {
      x: GAME_W+10, y: isTop ? Math.random()*40 : GAME_H - 60 - Math.random()*20,
      type: "saw", w: 20, h: 20, rot: 0
    };
    entities.push(s);
  }
}

function updateGame() {
  player.update();
  
  // Velocidade sobe bem devagar
  if (frames % 600 === 0) speed += 0.05;
  if (speed > 3) speed = 3;

  for (let i=entities.length-1; i>=0; i--) {
    let e = entities[i];
    
    // Skill Im√£
    if (e.type === "balloon" && SAVES.equipped.skill === "magnet") {
      let dx = player.x - e.x, dy = player.y - e.y;
      let d = Math.sqrt(dx*dx + dy*dy);
      if (d < 100) { e.x += dx/d*2; e.y += dy/d*2; }
      else e.x -= speed;
    } else {
      e.x -= speed;
    }
    
    // L√≥gica Serra
    if (e.type === "saw") e.rot += 0.2;
    if (e.type === "balloon") e.y += Math.sin(frames*0.1 + e.bob)*0.5;

    // Colis√£o
    if (checkColl(player, e)) {
      if (e.type === "balloon") {
        score++; SAVES.coins++;
        sfx("coin");
        createParticles(e.x, e.y, e.color, 5);
        entities.splice(i, 1);
      } else if (e.type === "saw") {
        if (player.hasShield) {
          player.hasShield = false;
          entities.splice(i, 1);
          createParticles(player.x, player.y, "#0ff", 10);
        } else {
          gameOver();
        }
      }
    } else if (e.x < -30) {
      entities.splice(i, 1);
    }
  }
  
  // Particulas
  for(let i=particles.length-1; i>=0; i--) {
    particles[i].x += particles[i].vx;
    particles[i].y += particles[i].vy;
    particles[i].life--;
    if(particles[i].life <= 0) particles.splice(i,1);
  }
}

function checkColl(p, e) {
  let pad = 2; // Margem de erro
  let pw = p.w - pad*2; let ph = p.h - pad*2;
  return p.x+pad < e.x + e.w && p.x+pad+pw > e.x &&
         p.y+pad < e.y + e.h && p.y+pad+ph > e.y;
}

function gameOver() {
  state = "GAMEOVER";
  sfx("die");
  if (score > SAVES.best) SAVES.best = score;
  saveData();
}

// ================= RENDER =================
function drawSkin(x, y, id) {
  // Cores Base
  let cMain = "#ccc", cHair = "#d00", cFace = "#fff";
  
  if(id === "zombie") { cMain = "#354"; cHair = "#222"; cFace = "#689"; }
  if(id === "shadow") { cMain = "#101"; cHair = "#000"; cFace = "#202"; }
  if(id === "mime")   { cMain = "#000"; cHair = "#000"; cFace = "#fff"; }

  // Corpo
  ctx.fillStyle = cMain; ctx.fillRect(x+2, y+10, 10, 12);
  // Cabe√ßa
  ctx.fillStyle = cFace; ctx.fillRect(x+1, y, 12, 10);
  // Cabelo
  ctx.fillStyle = cHair;
  if (id==="mime") ctx.fillRect(x+2, y-1, 8, 2);
  else { ctx.fillRect(x-1, y+2, 3, 5); ctx.fillRect(x+12, y+2, 3, 5); }
  
  // Detalhes Rosto
  ctx.fillStyle = (id==="shadow")?"#fff":"#000";
  ctx.fillRect(x+3, y+4, 2, 2); ctx.fillRect(x+9, y+4, 2, 2); // Olhos
  if(id!=="zombie" && id!=="shadow") { ctx.fillStyle="#d00"; ctx.fillRect(x+6, y+6, 2, 2); } // Nariz
}

function drawGame() {
  // BG
  ctx.fillStyle = "#090510"; ctx.fillRect(0,0,GAME_W,GAME_H);
  
  // Parallax Arvores
  ctx.fillStyle = "#160b24";
  for(let i=0; i<7; i++) {
    let h = 50 + Math.sin(i*132)*20;
    ctx.fillRect((i*40 - frames*0.2)%280 - 40, GAME_H-h-20, 26, h);
  }
  // Ch√£o
  ctx.fillStyle = "#221133"; ctx.fillRect(0, GAME_H-24, GAME_W, 24);

  // Entidades
  entities.forEach(e => {
    if(e.type === "balloon") {
      ctx.fillStyle = "#fff"; ctx.fillRect(e.x+4, e.y+12, 1, 8); // Fio
      ctx.fillStyle = e.color; drawRoundRect(ctx, e.x, e.y, 10, 12, 3);
    } else {
      ctx.save(); ctx.translate(e.x+10, e.y+10); ctx.rotate(e.rot);
      ctx.fillStyle = "#888"; 
      for(let j=0;j<4;j++){ ctx.rotate(Math.PI/2); ctx.fillRect(-2,-10,4,20); }
      ctx.restore();
    }
  });

  particles.forEach(p => {
    ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 2, 2);
  });

  player.draw();

  // HUD
  ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(0,0,GAME_W,20);
  ctx.fillStyle = "#fff"; ctx.font="8px 'Press Start 2P'"; ctx.textAlign="left";
  ctx.fillText(score, 5, 14);
  ctx.textAlign="right"; ctx.fillStyle="#fd0";
  ctx.fillText("$"+SAVES.coins, GAME_W-5, 14);
}

function drawMenu() {
  drawGame(); // Fundo animado
  ctx.fillStyle = "rgba(0,0,0,0.7)"; ctx.fillRect(20, 60, GAME_W-40, 200);
  
  ctx.fillStyle="#f05"; ctx.textAlign="center"; 
  ctx.font="12px 'Press Start 2P'"; ctx.fillText("VEM FLUTUAR", GAME_W/2, 90);
  
  ctx.fillStyle="#fff"; ctx.font="8px 'Press Start 2P'";
  ctx.fillText("RECORD: "+SAVES.best, GAME_W/2, 120);
  ctx.fillStyle="#fd0";
  ctx.fillText("COINS: "+SAVES.coins, GAME_W/2, 135);
  
  drawBtn("JOGAR", GAME_W/2-40, 170, 80, 24, true);
  drawBtn("LOJA", GAME_W/2-40, 205, 80, 24);
}

function drawShop() {
  ctx.fillStyle = "#111"; ctx.fillRect(0,0,GAME_W,GAME_H);
  
  // Tabs
  let tw = GAME_W/3;
  let tabs = ["balloons", "skins", "skills"];
  tabs.forEach((t, i) => {
    ctx.fillStyle = (shopTab===t) ? "#444" : "#222";
    ctx.fillRect(i*tw, 30, tw, 20);
    ctx.fillStyle = "#fff"; ctx.textAlign="center"; ctx.font="8px 'Press Start 2P'";
    let ico = (t==="balloons")?"üéà":(t==="skins"?"ü§°":"‚ö°");
    ctx.fillText(ico, i*tw + tw/2, 43);
  });

  // Lista
  let list = DB[shopTab];
  let y = 60;
  
  ctx.textAlign="right"; ctx.fillStyle="#fd0"; 
  ctx.fillText("$"+SAVES.coins, GAME_W-10, 20);

  list.forEach(item => {
    let owned = SAVES[shopTab].includes(item.id);
    let equipped = false;
    if (shopTab==="balloons" && SAVES.equipped.balloon === item.id) equipped = true;
    if (shopTab==="skins" && SAVES.equipped.skin === item.id) equipped = true;
    if (shopTab==="skills" && SAVES.equipped.skill === item.id) equipped = true;

    ctx.strokeStyle = equipped ? "#0f0" : "#444";
    ctx.strokeRect(10, y, GAME_W-20, 30);
    
    // Nome
    ctx.textAlign="left"; ctx.fillStyle="#fff";
    ctx.fillText(item.name, 15, y+12);
    // Pre√ßo
    ctx.textAlign="right";
    if (equipped) { ctx.fillStyle="#0f0"; ctx.fillText("USANDO", GAME_W-15, y+18); }
    else if (owned) { ctx.fillStyle="#aaa"; ctx.fillText("USAR", GAME_W-15, y+18); }
    else { ctx.fillStyle="#fe0"; ctx.fillText("$"+item.price, GAME_W-15, y+18); }
    
    y += 35;
  });
  
  drawBtn("VOLTAR", GAME_W/2-30, GAME_H-30, 60, 20);
}

function drawBtn(txt, x, y, w, h, hl) {
  ctx.fillStyle = hl ? "#c00" : "#333"; ctx.fillRect(x,y,w,h);
  ctx.strokeStyle = "#fff"; ctx.strokeRect(x,y,w,h);
  ctx.fillStyle = "#fff"; ctx.textAlign="center"; ctx.font="8px 'Press Start 2P'";
  ctx.fillText(txt, x+w/2, y+h/2+4);
}

function createParticles(x, y, c, q) {
  for(let i=0; i<q; i++) particles.push({x:x, y:y, vx:(Math.random()-0.5)*4, vy:(Math.random()-0.5)*4, life:30, color:c});
}

// ================= INPUT & LOOP =================
function resetGame() {
  score=0; speed=1.0; entities=[]; particles=[];
  player.reset();
}

function input(x, y) {
  initAudio();
  const r = canvas.getBoundingClientRect();
  const scale = GAME_W / r.width;
  const gx = (x - r.left) * scale;
  const gy = (y - r.top) * scale;

  if (state === "MENU") {
    if (gy > 170 && gy < 194) { resetGame(); state="GAME"; }
    else if (gy > 205 && gy < 230) state="SHOP";
  } 
  else if (state === "GAME") {
    player.jump();
  }
  else if (state === "GAMEOVER") {
    state = "MENU";
  }
  else if (state === "SHOP") {
    if (gy > GAME_H-30) { state="MENU"; return; }
    if (gy > 30 && gy < 50) {
      let tw = GAME_W/3;
      if (gx < tw) shopTab="balloons";
      else if (gx < tw*2) shopTab="skins";
      else shopTab="skills";
      return;
    }
    // L√≥gica Compra
    let list = DB[shopTab];
    let yStart = 60;
    list.forEach((item, i) => {
      let iy = yStart + i*35;
      if (gy > iy && gy < iy+30) {
        let owned = SAVES[shopTab].includes(item.id);
        if (owned) {
          if (shopTab==="balloons") SAVES.equipped.balloon = item.id;
          if (shopTab==="skins") SAVES.equipped.skin = item.id;
          if (shopTab==="skills") SAVES.equipped.skill = (SAVES.equipped.skill===item.id)?null:item.id;
          sfx("jump");
        } else if (SAVES.coins >= item.price) {
          SAVES.coins -= item.price;
          SAVES[shopTab].push(item.id);
          sfx("coin");
        } else {
          sfx("die");
        }
        saveData();
      }
    });
  }
}

window.addEventListener("mousedown", e=>input(e.clientX, e.clientY));
window.addEventListener("touchstart", e=>{e.preventDefault(); input(e.touches[0].clientX, e.touches[0].clientY);}, {passive:false});
window.addEventListener("keydown", e=>{ if(e.code==="Space") { if(state==="GAME") player.jump(); else input(window.innerWidth/2, window.innerHeight/2); } });

// Loop Principal
function loop() {
  requestAnimationFrame(loop);
  frames++;
  ctx.clearRect(0,0,GAME_W,GAME_H);
  
  if(state==="GAME") { spawn(); updateGame(); drawGame(); }
  else if(state==="MENU") drawMenu();
  else if(state==="SHOP") drawShop();
  else if(state==="GAMEOVER") { drawGame(); ctx.fillStyle="rgba(0,0,0,0.8)"; ctx.fillRect(20,100,GAME_W-40,80); ctx.fillStyle="#f00"; ctx.textAlign="center"; ctx.fillText("FIM DE JOGO", GAME_W/2, 145); }
}
loop();

} catch (err) {
  // Captura erros silenciosos e mostra na tela
  document.getElementById("error-msg").style.display = "block";
  document.getElementById("error-msg").innerHTML += "<br>"+err.message;
}
</script>
</body>
</html>
