<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Vamos Flutuar: Derry ðŸŽˆ</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  html, body { margin: 0; height: 100%; background-color: #05000a; display: flex; justify-content: center; align-items: center; overflow: hidden; touch-action: none; font-family: 'Press Start 2P', monospace; user-select: none; color: white; }
  #game-wrapper { position: relative; box-shadow: 0 0 50px rgba(100, 0, 0, 0.6); border: 4px solid #1a1a1a; overflow: hidden; background: #000; width: 240px; height: 360px; }
  canvas { display: block; background: #000; image-rendering: pixelated; width: 100%; height: 100%; }
  .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.15) 50%); background-size: 100% 4px; pointer-events: none; z-index: 10; }
  #credits { position: absolute; bottom: 10px; width: 100%; text-align: center; font-size: 6px; color: #666; letter-spacing: 1px; }

  /* ESTILO DAS JANELAS (MODAIS) */
  .modal {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 180px; background: #111; border: 3px solid red; padding: 15px;
    display: none; flex-direction: column; z-index: 100; box-shadow: 0 0 20px rgba(255,0,0,0.4);
  }
  .modal h2 { font-size: 8px; color: red; text-align: center; margin-bottom: 15px; }
  .modal input { 
    background: #000; border: 1px solid #333; color: white; 
    font-family: 'Press Start 2P'; font-size: 6px; padding: 8px; margin-bottom: 10px; outline: none;
  }
  .modal button {
    background: red; border: none; color: white; font-family: 'Press Start 2P';
    font-size: 6px; padding: 8px; cursor: pointer; margin-bottom: 5px;
  }
  .modal .close-btn { background: #333; }
</style>
</head>
<body>

<div id="game-wrapper">
  <canvas id="game"></canvas>
  
  <div id="modal-auth" class="modal">
    <h2 id="auth-title">LOGIN / CADASTRO</h2>
    <input type="email" id="email" placeholder="E-MAIL">
    <input type="password" id="pass" placeholder="SENHA">
    <button onclick="handleAuth()">CONFIRMAR</button>
    <button class="close-btn" onclick="closeModals()">FECHAR</button>
  </div>

  <div id="modal-redeem" class="modal">
    <h2>RESGATAR CÃ“DIGO</h2>
    <input type="text" id="redeem-code" placeholder="CÃ“DIGO">
    <button onclick="handleRedeem()">RESGATAR</button>
    <button class="close-btn" onclick="closeModals()">FECHAR</button>
  </div>

  <div class="overlay"></div>
  <div id="credits">BY: @CARLUZSNT</div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAihGsa8MKG30r8aoj6tnMBuM9e-Bk5eEI",
    authDomain: "vamos-flutuar.firebaseapp.com",
    projectId: "vamos-flutuar",
    storageBucket: "vamos-flutuar.firebasestorage.app",
    messagingSenderId: "21354937126",
    appId: "1:21354937126:web:3c2c46a9bb287e4d2c1fe7"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  window.fbUser = null;

  window.syncCloud = async () => {
    if (!window.fbUser) return;
    const ref = doc(db, "users", window.fbUser.uid);
    const snap = await getDoc(ref);
    if (snap.exists()) {
      const data = snap.data();
      SAVES.coins = data.coins || SAVES.coins;
      SAVES.best = data.best || SAVES.best;
      SAVES.balloons = data.balloons || SAVES.balloons;
      SAVES.usedCodes = data.usedCodes || [];
      saveData();
    } else {
      await setDoc(ref, { coins: SAVES.coins, best: SAVES.best, balloons: SAVES.balloons, usedCodes: [], email: window.fbUser.email });
    }
  };

  window.handleAuth = async () => {
    const email = document.getElementById("email").value;
    const pass = document.getElementById("pass").value;
    if(!email || !pass) return alert("PREENCHA TUDO");

    try {
      const res = await signInWithEmailAndPassword(auth, email, pass);
      window.fbUser = res.user;
      closeModals();
    } catch (err) {
      if (err.code.includes('user-not-found') || err.code.includes('wrong-password') || err.code.includes('invalid-credential')) {
        try {
          const res = await createUserWithEmailAndPassword(auth, email, pass);
          window.fbUser = res.user;
          closeModals();
          alert("CONTA CRIADA!");
        } catch (e) { alert("ERRO: " + e.message); }
      } else { alert("ERRO: " + err.message); }
    }
  };

  window.handleRedeem = async () => {
    if (!window.fbUser) return alert("FAÃ‡A LOGIN PRIMEIRO!");
    const input = document.getElementById("redeem-code").value.trim().toUpperCase();
    if (!input) return;

    if (!SAVES.usedCodes) SAVES.usedCodes = [];

    // VerificaÃ§Ã£o dupla para evitar resgate mÃºltiplo
    if (SAVES.usedCodes.includes(input)) {
        alert("CÃ“DIGO JÃ UTILIZADO NESTA CONTA!");
        return;
    }

    if (input === "FLUTUAR") {
        SAVES.coins += 500;
        SAVES.usedCodes.push("FLUTUAR");
        saveData();
        alert("RESGATADO: +500 MOEDAS!");
        closeModals();
    } else if (input === "DERRY") {
        SAVES.coins += 1000;
        SAVES.usedCodes.push("DERRY");
        saveData();
        alert("RESGATADO: +1000 MOEDAS!");
        closeModals();
    } else {
        alert("CÃ“DIGO INVÃLIDO");
    }
  };

  onAuthStateChanged(auth, (user) => {
    window.fbUser = user;
    if (user) window.syncCloud();
  });

  window.saveToCloud = async () => {
    if (!window.fbUser) return;
    const ref = doc(db, "users", window.fbUser.uid);
    await updateDoc(ref, { 
      coins: SAVES.coins, best: SAVES.best, balloons: SAVES.balloons, usedCodes: SAVES.usedCodes || []
    });
  };
</script>

<script>
// ================= JOGO =================
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d", { alpha: false });
const GAME_W = 240; const GAME_H = 360;

function resize() {
  const scale = Math.min(window.innerWidth / GAME_W, window.innerHeight / GAME_H);
  const wrapper = document.getElementById("game-wrapper");
  wrapper.style.width = Math.floor(GAME_W * scale) + "px";
  wrapper.style.height = Math.floor(GAME_H * scale) + "px";
  canvas.width = GAME_W; canvas.height = GAME_H;
}
window.addEventListener('resize', resize); resize();

let SAVES = {
  coins: parseInt(localStorage.getItem("coins")) || 0,
  best: parseInt(localStorage.getItem("best")) || 0,
  balloons: JSON.parse(localStorage.getItem("myBalloons")) || ["red"],
  equipped: { balloon: localStorage.getItem("eqBalloon") || "red" },
  usedCodes: JSON.parse(localStorage.getItem("usedCodes")) || []
};

function saveData() {
  localStorage.setItem("coins", SAVES.coins);
  localStorage.setItem("best", SAVES.best);
  localStorage.setItem("myBalloons", JSON.stringify(SAVES.balloons));
  localStorage.setItem("eqBalloon", SAVES.equipped.balloon);
  localStorage.setItem("usedCodes", JSON.stringify(SAVES.usedCodes));
  if(window.saveToCloud) window.saveToCloud();
}

function closeModals() {
    document.getElementById("modal-auth").style.display = "none";
    document.getElementById("modal-redeem").style.display = "none";
}

// FunÃ§Ãµes de desenho e lÃ³gica (simplificadas para o cÃ³digo completo)
const DB = { balloons: [{id:"red", price:0, color:"#ff0000"}, {id:"blue", price:50, color:"#0088ff"}, {id:"green", price:150, color:"#00ff00"}, {id:"gold", price:500, color:"#ffcc00"}, {id:"cyan", price:1000, color:"#00ffff"}] };
let state = "MENU", frames = 0, score = 0, speed = 2, entities = [], gameStarted = false;
const player = { x: 50, y: 150, vy: 0, g: 0.18, jf: -3.8, reset() { this.y=150; this.vy=0; score=0; entities=[]; gameStarted=false; } };

function handleInput(e) {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
  if (e.cancelable) e.preventDefault();
  const r = canvas.getBoundingClientRect(); const touch = (e.touches && e.touches[0]) || e;
  const gx = (touch.clientX - r.left) * (GAME_W / r.width); const gy = (touch.clientY - r.top) * (GAME_H / r.height);

  if (state === "MENU") {
    if (gy > 140 && gy < 170) { player.reset(); state="GAME"; }
    else if (gy > 180 && gy < 210) state="SHOP";
    else if (gy > 220 && gy < 250) document.getElementById("modal-auth").style.display = "flex";
    else if (gy > 260 && gy < 290) document.getElementById("modal-redeem").style.display = "flex";
  } else if (state === "GAME") { gameStarted = true; player.vy = player.jf; }
}
window.addEventListener("touchstart", handleInput, {passive:false});
window.addEventListener("mousedown", handleInput);

function drawBallon(x, y, color) {
  ctx.strokeStyle = "#fff"; ctx.beginPath(); ctx.moveTo(x+6, y+14); ctx.lineTo(x+6, y+22); ctx.stroke();
  ctx.fillStyle = color; ctx.beginPath(); ctx.ellipse(x+6, y+7, 6, 8, 0, 0, Math.PI*2); ctx.fill();
}

function loop() {
  ctx.fillStyle = "#05000a"; ctx.fillRect(0,0,GAME_W,GAME_H);
  if (state === "MENU") {
    ctx.textAlign = "center"; ctx.font = "14px 'Press Start 2P'"; ctx.fillStyle = "red";
    ctx.fillText("VAMOS FLUTUAR", 120, 60);
    const btn = (t, y, c="red") => { ctx.fillStyle="#111"; ctx.fillRect(40, y, 160, 25); ctx.strokeStyle=c; ctx.strokeRect(40, y, 160, 25); ctx.fillStyle="white"; ctx.font="6px 'Press Start 2P'"; ctx.fillText(t, 120, y+16); };
    btn("JOGAR", 140); btn("LOJA", 180);
    let userT = window.fbUser ? window.fbUser.email.split("@")[0].toUpperCase() : "LOGIN / CADASTRO";
    btn(userT, 220, window.fbUser ? "#0f0" : "red");
    btn("RESGATAR CÃ“DIGO", 260, "cyan");
  } else if (state === "GAME") {
      if(gameStarted) { player.vy += player.g; player.y += player.vy; }
      if(player.y > 320 || player.y < 0) state = "MENU";
      drawBallon(player.x, player.y, DB.balloons.find(b=>b.id===SAVES.equipped.balloon).color);
  }
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
