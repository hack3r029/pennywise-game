<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Vamos Flutuar: Derry ðŸŽˆ</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  html, body { margin: 0; height: 100%; background-color: #05000a; display: flex; justify-content: center; align-items: center; overflow: hidden; touch-action: none; font-family: 'Press Start 2P', monospace; user-select: none; color: white; }
  #game-wrapper { position: relative; box-shadow: 0 0 50px rgba(100, 0, 0, 0.6); border: 4px solid #1a1a1a; overflow: hidden; background: #000; width: 240px; height: 360px; }
  canvas { display: block; background: #000; image-rendering: pixelated; width: 100%; height: 100%; }
  .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.15) 50%); background-size: 100% 4px; pointer-events: none; z-index: 10; }
  #credits { position: absolute; bottom: 10px; width: 100%; text-align: center; font-size: 6px; color: #666; letter-spacing: 1px; }
</style>
</head>
<body>

<div id="game-wrapper">
  <canvas id="game"></canvas>
  <div class="overlay"></div>
  <div id="credits">BY: @CARLUZSNT</div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAihGsa8MKG30r8aoj6tnMBuM9e-Bk5eEI",
    authDomain: "vamos-flutuar.firebaseapp.com",
    projectId: "vamos-flutuar",
    storageBucket: "vamos-flutuar.firebasestorage.app",
    messagingSenderId: "21354937126",
    appId: "1:21354937126:web:3c2c46a9bb287e4d2c1fe7"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  window.fbUser = null;

  window.syncCloud = async () => {
    if (!window.fbUser) return;
    const ref = doc(db, "users", window.fbUser.uid);
    const snap = await getDoc(ref);
    if (snap.exists()) {
      const data = snap.data();
      SAVES.coins = data.coins !== undefined ? data.coins : SAVES.coins;
      SAVES.best = data.best !== undefined ? data.best : SAVES.best;
      SAVES.balloons = data.balloons || SAVES.balloons;
      SAVES.usedCodes = data.usedCodes || [];
      saveData();
    } else {
      await setDoc(ref, { 
        coins: SAVES.coins, 
        best: SAVES.best, 
        balloons: SAVES.balloons, 
        usedCodes: SAVES.usedCodes,
        email: window.fbUser.email 
      });
    }
  };

  window.authEmail = async () => {
    const email = prompt("E-MAIL:");
    if(!email) return;
    const pass = prompt("SENHA (MÃN. 6 DÃGITOS):");
    if(!pass) return;

    try {
      const res = await signInWithEmailAndPassword(auth, email, pass);
      window.fbUser = res.user;
    } catch (err) {
      if (err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
        try {
          const res = await createUserWithEmailAndPassword(auth, email, pass);
          window.fbUser = res.user;
          alert("CONTA CRIADA!");
        } catch (e) { alert("ERRO: " + e.message); }
      } else { alert("ERRO: " + err.message); }
    }
  };

  onAuthStateChanged(auth, (user) => {
    window.fbUser = user;
    if (user) window.syncCloud();
  });

  window.saveToCloud = async () => {
    if (!window.fbUser) return;
    const ref = doc(db, "users", window.fbUser.uid);
    await updateDoc(ref, { 
      coins: SAVES.coins, 
      best: SAVES.best, 
      balloons: SAVES.balloons,
      usedCodes: SAVES.usedCodes 
    });
  };
</script>

<script>
// ================= CONFIGURAÃ‡Ã•ES =================
const LANGS = {
  pt: { play: "JOGAR", shop: "LOJA", back: "VOLTAR", close: "FECHAR", buy: "COMPRAR", use: "EQUIPAR", used: "EQUIPADO", soon: "EM BREVE", items: { red: "SANGUE", blue: "NOTURNO", green: "TOXICO", gold: "OURO", cyan: "NEON" } }
};

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d", { alpha: false });
const GAME_W = 240; const GAME_H = 360;

function resize() {
  const scale = Math.min(window.innerWidth / GAME_W, window.innerHeight / GAME_H);
  const wrapper = document.getElementById("game-wrapper");
  wrapper.style.width = Math.floor(GAME_W * scale) + "px";
  wrapper.style.height = Math.floor(GAME_H * scale) + "px";
  canvas.width = GAME_W; canvas.height = GAME_H;
}
window.addEventListener('resize', resize); resize();

// ================= DATA =================
const DB = {
  balloons: [
    {id:"red", price:0, color:"#ff0000"}, 
    {id:"blue", price:50, color:"#0088ff"}, 
    {id:"green", price:150, color:"#00ff00"}, 
    {id:"gold", price:500, color:"#ffcc00"}, 
    {id:"cyan", price:1000, color:"#00ffff"}
  ]
};

let SAVES = {
  coins: parseInt(localStorage.getItem("coins")) || 0,
  best: parseInt(localStorage.getItem("best")) || 0,
  balloons: JSON.parse(localStorage.getItem("myBalloons")) || ["red"],
  equipped: { balloon: localStorage.getItem("eqBalloon") || "red" },
  usedCodes: JSON.parse(localStorage.getItem("usedCodes")) || []
};

function saveData() {
  localStorage.setItem("coins", SAVES.coins);
  localStorage.setItem("best", SAVES.best);
  localStorage.setItem("myBalloons", JSON.stringify(SAVES.balloons));
  localStorage.setItem("eqBalloon", SAVES.equipped.balloon);
  localStorage.setItem("usedCodes", JSON.stringify(SAVES.usedCodes));
  if(window.saveToCloud) window.saveToCloud();
}

// ================= AUDIO =================
let actx = null;
function initAudio() { if(!actx) actx = new (window.AudioContext || window.webkitAudioContext)(); }
function sfx(freq, type, duration) {
  if(!actx) return;
  const osc = actx.createOscillator(); const g = actx.createGain();
  osc.type = type; osc.frequency.setValueAtTime(freq, actx.currentTime);
  g.gain.setValueAtTime(0.1, actx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, actx.currentTime + duration);
  osc.connect(g); g.connect(actx.destination); osc.start(); osc.stop(actx.currentTime + duration);
}

// ================= DRAWING =================
function drawDerryCity() {
  ctx.fillStyle = "#05000a"; ctx.fillRect(0, 0, GAME_W, GAME_H);
  ctx.fillStyle = "#0d0616"; ctx.fillRect(0, 180, GAME_W, 180);
  ctx.fillStyle = "#000"; ctx.fillRect(0, 320, GAME_W, 40);
}

function drawSkin(x, y) {
  ctx.save(); ctx.translate(x, y);
  ctx.fillStyle = "#d00"; ctx.fillRect(-2, 2, 4, 6); ctx.fillRect(12, 2, 4, 6);
  ctx.fillStyle = "#ccc"; ctx.fillRect(2, 10, 10, 12);
  ctx.fillStyle = "#fff"; ctx.fillRect(1, 0, 12, 10);
  ctx.fillStyle = "#222"; ctx.fillRect(3, 3, 2, 2); ctx.fillRect(9, 3, 2, 2);
  ctx.restore();
}

function drawBallon(x, y, color, sc=1) {
  ctx.save(); ctx.translate(x, y); ctx.scale(sc, sc);
  ctx.strokeStyle = "#fff"; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(6, 14); ctx.lineTo(6, 22); ctx.stroke();
  ctx.fillStyle = color; ctx.beginPath(); ctx.ellipse(6, 7, 6, 8, 0, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = "rgba(255,255,255,0.3)"; ctx.beginPath(); ctx.ellipse(4, 5, 2, 3, 0, 0, Math.PI*2); ctx.fill();
  ctx.restore();
}

function drawSaw(x, y, angle) {
  ctx.save(); ctx.translate(x + 10, y + 10); ctx.rotate(angle);
  ctx.fillStyle = "#666";
  for(let i=0; i<8; i++) { ctx.rotate(Math.PI/4); ctx.beginPath(); ctx.moveTo(0, -12); ctx.lineTo(4, -8); ctx.lineTo(-4, -8); ctx.fill(); }
  ctx.fillStyle = "#999"; ctx.beginPath(); ctx.arc(0, 0, 8, 0, Math.PI*2); ctx.fill();
  ctx.restore();
}

// ================= GAME LOGIC =================
let state = "MENU", frames = 0, score = 0, speed = 2, shopTab = "balloons", previewItem = null, gameStarted = false;
let entities = []; 
let redeemStatus = "";

const player = { x: 50, y: 150, w: 14, h: 22, vy: 0, g: 0.18, jf: -3.8, 
  reset() { this.y = 150; this.vy = 0; gameStarted = false; entities=[]; score=0; }
};

function processRedeem() {
    if (!window.fbUser) {
        alert("FAÃ‡A LOGIN PARA RESGATAR!");
        return;
    }
    let input = prompt("DIGITE O CÃ“DIGO:");
    if (!input) return;
    let code = input.trim().toUpperCase();

    if (SAVES.usedCodes.includes(code)) {
        redeemStatus = "JÃ RESGATADO!";
    } else if (code === "FLUTUAR") {
        SAVES.coins += 500;
        SAVES.usedCodes.push(code);
        redeemStatus = "+500 MOEDAS!";
        saveData();
    } else if (code === "DERRY") {
        SAVES.coins += 1000;
        SAVES.usedCodes.push(code);
        redeemStatus = "+1000 MOEDAS!";
        saveData();
    } else {
        redeemStatus = "INVÃLIDO";
    }
    setTimeout(() => redeemStatus = "", 2000);
}

function updateGame() {
  if(!gameStarted) return;
  player.vy += player.g; player.y += player.vy;
  if (player.y > GAME_H - 40 || player.y < -35) { sfx(100, 'sawtooth', 0.3); state = "GAMEOVER"; if(score > SAVES.best) SAVES.best = score; saveData(); return; }
  
  frames++;
  for (let i = entities.length - 1; i >= 0; i--) {
    let e = entities[i]; e.x -= speed;
    if(e.type === "saw") e.angle += 0.2;
    if (player.x < e.x + 18 && player.x + 14 > e.x && player.y < e.y + 18 && player.y + 22 > e.y) {
      if (e.type === "balloon") { score++; SAVES.coins++; sfx(800, 'sine', 0.1); entities.splice(i, 1); }
      else { sfx(100, 'sawtooth', 0.3); state = "GAMEOVER"; if(score > SAVES.best) SAVES.best = score; saveData(); }
    }
    if (e.x < -40) entities.splice(i, 1);
  }
  if (frames % 100 === 0) entities.push({x:GAME_W+20, y:50+Math.random()*200, type:"balloon", color:DB.balloons.find(b=>b.id===SAVES.equipped.balloon).color});
  if (frames % 160 === 0) entities.push({x:GAME_W+20, y:Math.random()*280, type:"saw", angle: 0});
}

// ================= INPUT =================
function handleInput(e) {
  if (e.cancelable) e.preventDefault();
  initAudio();
  const r = canvas.getBoundingClientRect(); const touch = (e.touches && e.touches[0]) || e;
  const gx = (touch.clientX - r.left) * (GAME_W / r.width); const gy = (touch.clientY - r.top) * (GAME_H / r.height);

  if (state === "MENU") {
    if (gy > 140 && gy < 170) { player.reset(); state="GAME"; }
    else if (gy > 180 && gy < 210) state="SHOP";
    else if (gy > 220 && gy < 250) { if(window.authEmail) window.authEmail(); }
    else if (gy > 260 && gy < 290) processRedeem();
  } else if (state === "GAMEOVER") {
    if (gy > 200 && gy < 230) { player.reset(); state="GAME"; }
    else if (gy > 240 && gy < 270) state="MENU";
  } else if (state === "SHOP") {
    if (previewItem) {
      if (gy > 230 && gy < 265) {
        if (SAVES.balloons.includes(previewItem.id)) { SAVES.equipped.balloon = previewItem.id; sfx(400, 'sine', 0.1); }
        else if (SAVES.coins >= previewItem.price) { SAVES.coins -= previewItem.price; SAVES.balloons.push(previewItem.id); sfx(600, 'sine', 0.2); }
        saveData();
      } else if (gy > 280) previewItem = null;
    } else {
      if (gy > 320) state="MENU";
      else if (gy > 30 && gy < 55) shopTab = ["balloons", "skins", "skills"][Math.floor(gx/80)];
      else if (shopTab === "balloons") DB.balloons.forEach((item, i) => { if(gy > 70+i*42 && gy < 105+i*42) previewItem = item; });
    }
  } else if (state === "GAME") { gameStarted = true; player.vy = player.jf; sfx(400, 'sine', 0.05); }
}
window.addEventListener("touchstart", handleInput, {passive:false});
window.addEventListener("mousedown", handleInput);

// ================= LOOP =================
function loop() {
  drawDerryCity();
  if(state==="GAME") { 
    updateGame();
    entities.forEach(e => { if(e.type === "balloon") drawBallon(e.x, e.y, e.color); else drawSaw(e.x, e.y, e.angle); });
    drawBallon(player.x-2, player.y-18, DB.balloons.find(b=>b.id===SAVES.equipped.balloon).color);
    drawSkin(player.x, player.y);
    ctx.fillStyle="white"; ctx.font="8px 'Press Start 2P'"; ctx.textAlign="left"; ctx.fillText(score, 10, 20);
    ctx.textAlign="right"; ctx.fillText("$"+SAVES.coins, GAME_W-10, 20);
  } else if(state==="MENU") {
    ctx.textAlign = "center"; ctx.font = "14px 'Press Start 2P'"; ctx.fillStyle = "red";
    ctx.fillText("VAMOS", 120, 45); ctx.fillText("FLUTUAR", 120, 70);
    const btn = (t, y, c="red") => { ctx.fillStyle="#111"; ctx.fillRect(40, y, 160, 25); ctx.strokeStyle=c; ctx.strokeRect(40, y, 160, 25); ctx.fillStyle="white"; ctx.font="6px 'Press Start 2P'"; ctx.fillText(t, 120, y+16); };
    btn("JOGAR", 140);
    btn("LOJA", 180);
    let userT = window.fbUser ? window.fbUser.email.split("@")[0].toUpperCase() : "LOGIN / CADASTRAR";
    btn(userT, 220, window.fbUser ? "#0f0" : "red");
    btn(redeemStatus || "RESGATAR CÃ“DIGO", 260, "cyan");
  } else if(state==="GAMEOVER") {
    ctx.fillStyle="rgba(0,0,0,0.85)"; ctx.fillRect(0,0,GAME_W,GAME_H);
    ctx.fillStyle="red"; ctx.textAlign="center"; ctx.fillText("FIM DE JOGO", 120, 100);
    const btn = (t, y) => { ctx.fillStyle="#111"; ctx.fillRect(45, y, 150, 30); ctx.strokeStyle="white"; ctx.strokeRect(45, y, 150, 30); ctx.fillStyle="white"; ctx.fillText(t, 120, y+20); };
    btn("RECOMECAR", 200); btn("MENU", 240);
  } else if(state==="SHOP") {
    ctx.fillStyle="#000"; ctx.fillRect(0,0,GAME_W,GAME_H);
    ["BALÃ•ES", "SKINS", "PODERES"].forEach((t, i) => { 
        ctx.fillStyle=(i===0&&shopTab==="balloons")||(i===1&&shopTab==="skins")||(i===2&&shopTab==="skills")?"red":"#222"; 
        ctx.fillRect(i*80, 30, 80, 25); ctx.fillStyle="white"; ctx.font="5px 'Press Start 2P'"; ctx.textAlign="center"; ctx.fillText(t, i*80+40, 46); 
    });
    if(shopTab === "balloons") {
      DB.balloons.forEach((item, i) => { 
        let y=70+i*42; let isUsed = SAVES.equipped.balloon === item.id;
        ctx.fillStyle=isUsed?"#030":"#111"; ctx.fillRect(10, y, 220, 35); 
        ctx.strokeStyle=isUsed?"#0f0":"#333"; ctx.strokeRect(10, y, 220, 35);
        ctx.fillStyle="white"; ctx.font="7px 'Press Start 2P'"; ctx.textAlign="left"; ctx.fillText(LANGS.pt.items[item.id], 20, y+22);
        ctx.textAlign="right"; ctx.fillStyle=isUsed?"#0f0":"#ffd700"; ctx.fillText(isUsed?"USANDO": (SAVES.balloons.includes(item.id)?"TER":"$"+item.price), 220, y+22);
      });
    } else { ctx.fillStyle="white"; ctx.font="8px 'Press Start 2P'"; ctx.textAlign="center"; ctx.fillText("EM BREVE", 120, 180); }
    ctx.textAlign="center"; ctx.font="8px 'Press Start 2P'"; ctx.fillText("VOLTAR", 120, 345);
    if(previewItem) {
      ctx.fillStyle="rgba(0,0,0,0.95)"; ctx.fillRect(0,0,GAME_W,GAME_H);
      ctx.fillStyle="white"; ctx.textAlign="center"; ctx.fillText(LANGS.pt.items[previewItem.id], 120, 80);
      drawBallon(105, 120, previewItem.color, 2.5);
      let isOwned = SAVES.balloons.includes(previewItem.id);
      let isEquipped = SAVES.equipped.balloon === previewItem.id;
      ctx.fillStyle = isEquipped ? "#050" : "red";
      ctx.fillRect(60, 235, 120, 35);
      ctx.fillStyle = "white";
      let btnText = isEquipped ? "EQUIPADO" : (isOwned ? "EQUIPAR" : "COMPRAR");
      ctx.fillText(btnText, 120, 258);
      ctx.fillText("FECHAR", 120, 300);
      if(isEquipped) { ctx.strokeStyle="#0f0"; ctx.strokeRect(60, 235, 120, 35); }
    }
  }
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
