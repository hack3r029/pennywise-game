<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Vamos Flutuar: Derry ðŸŽˆ</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  html, body { margin: 0; height: 100%; background-color: #05000a; display: flex; justify-content: center; align-items: center; overflow: hidden; touch-action: none; font-family: 'Press Start 2P', monospace; user-select: none; color: white; }
  #game-wrapper { position: relative; box-shadow: 0 0 50px rgba(100, 0, 0, 0.6); border: 4px solid #1a1a1a; overflow: hidden; background: #000; width: 240px; height: 360px; }
  canvas { display: block; background: #000; image-rendering: pixelated; width: 100%; height: 100%; }
  .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.15) 50%); background-size: 100% 4px; pointer-events: none; z-index: 10; }
  #insta-link { position: absolute; display: none; color: #f00; font-size: 8px; text-decoration: none; z-index: 100; text-align: center; width: 100%; bottom: 15px; letter-spacing: 1px; }
</style>
</head>
<body>

<div id="game-wrapper">
  <canvas id="game"></canvas>
  <div class="overlay"></div>
  <a id="insta-link" href="https://instagram.com/carluzsnt" target="_blank">BY @CARLUZSNT</a>
</div>

<script>
const LANGS = {
  pt: { play: "JOGAR", shop: "LOJA", settings: "CONFIGS", back: "VOLTAR", close: "FECHAR", buy: "COMPRAR", use: "USAR", soon: "EM BREVE", retry: "RECOMECAR", menu: "MENU", score: "RECORD", balloons: "BALOES", skins: "SKINS", skills: "PODERES", over: "FIM DE JOGO", music: "MUSICA", sfx: "EFEITOS", items: { red: "SANGUE", blue: "NOTURNO", green: "TOXICO", gold: "OURO", cyan: "NEON" }, descs: { red: "O CLASSICO.", blue: "CEU PROFUNDO.", green: "BRILHA MUITO.", gold: "PURO LUXO.", cyan: "LUZ VIBRANTE." } },
  es: { play: "JUGAR", shop: "TIENDA", settings: "CONFIGS", back: "VOLVER", close: "CERRAR", buy: "COMPRAR", use: "USAR", soon: "MUY PRONTO", retry: "REINTENTAR", menu: "MENU", score: "RECORD", balloons: "GLOBOS", skins: "PIELES", skills: "PODERES", over: "FIN JUEGO", music: "MUSICA", sfx: "EFECTOS", items: { red: "SANGRE", blue: "NOCHE", green: "TOXICO", gold: "ORO", cyan: "NEON" }, descs: { red: "EL CLASICO.", blue: "CIELO OSCURO.", green: "BRILLA MUCHO.", gold: "PURO ORO.", cyan: "LUZ VIVA." } },
  en: { play: "PLAY", shop: "SHOP", settings: "SETTINGS", back: "BACK", close: "CLOSE", buy: "BUY", use: "USE", soon: "COMING SOON", retry: "RETRY", menu: "MENU", score: "BEST", balloons: "BALLOONS", skins: "SKINS", skills: "SKILLS", over: "GAME OVER", music: "MUSIC", sfx: "SFX", items: { red: "BLOOD", blue: "NIGHT", green: "TOXIC", gold: "GOLD", cyan: "NEON" }, descs: { red: "THE CLASSIC.", blue: "DEEP SKY.", green: "GLOWS DARK.", gold: "PURE WEALTH.", cyan: "VIBRANT LIGHT." } }
};

let currentLang = localStorage.getItem("lang") || "pt";
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d", { alpha: false });
const GAME_W = 240; const GAME_H = 360;
const instaBtn = document.getElementById("insta-link");

function resize() {
  const scale = Math.min(window.innerWidth / GAME_W, window.innerHeight / GAME_H);
  const wrapper = document.getElementById("game-wrapper");
  wrapper.style.width = Math.floor(GAME_W * scale) + "px";
  wrapper.style.height = Math.floor(GAME_H * scale) + "px";
  canvas.width = GAME_W; canvas.height = GAME_H;
}
window.addEventListener('resize', resize); resize();

let volMusic = parseFloat(localStorage.getItem("volMusic")) ?? 0.4;
let volSfx = parseFloat(localStorage.getItem("volSfx")) ?? 0.6;

const DB = {
  balloons: [{id:"red", price:0, color:"#d00"}, {id:"blue", price:50, color:"#2ad"}, {id:"green", price:100, color:"#0f0"}, {id:"gold", price:300, color:"#ffd700"}, {id:"cyan", price:500, color:"#0ffff"}]
};

let SAVES = {
  coins: parseInt(localStorage.getItem("coins")) || 0,
  best: parseInt(localStorage.getItem("best")) || 0,
  balloons: JSON.parse(localStorage.getItem("myBalloons")) || ["red"],
  equipped: { balloon: localStorage.getItem("eqBalloon") || "red", skin: "classic" }
};

function saveData() {
  localStorage.setItem("coins", SAVES.coins); localStorage.setItem("best", SAVES.best);
  localStorage.setItem("myBalloons", JSON.stringify(SAVES.balloons)); localStorage.setItem("eqBalloon", SAVES.equipped.balloon);
  localStorage.setItem("lang", currentLang); localStorage.setItem("volMusic", volMusic); localStorage.setItem("volSfx", volSfx);
}

// ================= SISTEMA DE ÃUDIO REFEITO =================
let actx = null, musicStarted = false;

function initAudio() {
  if (!actx) actx = new (window.AudioContext || window.webkitAudioContext)();
  if (actx.state === 'suspended') actx.resume();
}

function playTerrorMusic() {
  if (!actx || musicStarted) return;
  musicStarted = true;
  const loop = () => {
    if(!actx) return;
    const now = actx.currentTime;
    const osc = actx.createOscillator();
    const g = actx.createGain();
    osc.type = "sine";
    osc.frequency.setValueAtTime(55, now);
    osc.frequency.exponentialRampToValueAtTime(45, now + 4);
    g.gain.setValueAtTime(0, now);
    g.gain.linearRampToValueAtTime(0.1 * volMusic, now + 1);
    g.gain.linearRampToValueAtTime(0, now + 4);
    osc.connect(g); g.connect(actx.destination);
    osc.start(now); osc.stop(now + 4);
    setTimeout(loop, 4000);
  };
  loop();
}

function sfx(type) {
  if (!actx || actx.state === 'suspended') return;
  const osc = actx.createOscillator();
  const g = actx.createGain();
  osc.connect(g); g.connect(actx.destination);
  g.gain.setValueAtTime(volSfx * 0.2, actx.currentTime);
  if (type === "jump") {
    osc.frequency.setValueAtTime(150, actx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(400, actx.currentTime + 0.1);
    osc.start(); osc.stop(actx.currentTime + 0.1);
  } else if (type === "coin") {
    osc.frequency.setValueAtTime(880, actx.currentTime);
    osc.start(); osc.stop(actx.currentTime + 0.08);
  } else if (type === "die") {
    osc.frequency.setValueAtTime(100, actx.currentTime);
    osc.frequency.linearRampToValueAtTime(20, actx.currentTime + 0.5);
    g.gain.exponentialRampToValueAtTime(0.001, actx.currentTime + 0.5);
    osc.start(); osc.stop(actx.currentTime + 0.5);
  }
}

// ================= JOGO =================
let state = "MENU", frames = 0, score = 0, speed = 1.8, shopTab = "balloons", previewItem = null, gameStarted = false;
let entities = [];
const player = { x: 50, y: 150, w: 14, h: 22, vy: 0, g: 0.16, jf: -3.5, reset() { this.y = 150; this.vy = 0; score = 0; entities = []; gameStarted = false; } };

function drawDerryCity(speedMult) {
  ctx.fillStyle = "#05000a"; ctx.fillRect(0, 0, GAME_W, GAME_H);
  ctx.fillStyle = "#111"; ctx.fillRect(0, 180, GAME_W, 180);
  ctx.fillStyle = "#000"; ctx.fillRect(0, 320, GAME_W, 40);
}

function updateGame() {
  if(!gameStarted) return;
  player.vy += player.g; player.y += player.vy;
  
  if (player.y > 300 || player.y < -40) {
    sfx("die"); state = "GAMEOVER"; if(score > SAVES.best) SAVES.best = score; saveData(); return;
  }

  for (let i = 0; i < entities.length; i++) {
    let e = entities[i]; e.x -= speed;
    if (player.x < e.x + e.w && player.x + 14 > e.x && player.y < e.y + e.h && player.y + 22 > e.y) {
      if (e.type === "balloon") {
        score++; SAVES.coins++; sfx("coin");
        entities.splice(i, 1); i--;
      } else {
        sfx("die"); state = "GAMEOVER"; if(score > SAVES.best) SAVES.best = score; saveData(); return;
      }
    }
  }
  entities = entities.filter(e => e.x > -50);
  if (frames % 100 === 0) entities.push({x:GAME_W+20, y:50+Math.random()*200, type:"balloon", w:12, h:15, color:DB.balloons.find(b=>b.id===SAVES.equipped.balloon).color});
  if (frames % 160 === 0) entities.push({x:GAME_W+20, y:Math.random()*280, type:"saw", w:18, h:18});
}

function handleInput(e) {
  if (e.cancelable) e.preventDefault();
  initAudio(); playTerrorMusic();
  const r = canvas.getBoundingClientRect(); const t = (e.touches && e.touches[0]) || e;
  const gx = (t.clientX - r.left) * (GAME_W / r.width); const gy = (t.clientY - r.top) * (GAME_H / r.height);

  if (state === "MENU") {
    if (gy > 160 && gy < 190) { player.reset(); state="GAME"; }
    else if (gy > 200 && gy < 230) state="SHOP";
    else if (gy > 240 && gy < 270) state="SETTINGS";
  } else if (state === "SETTINGS") {
    if (gy > 115 && gy < 145) { if(gx < 80) currentLang="pt"; else if(gx < 160) currentLang="es"; else currentLang="en"; }
    if (gy > 170 && gy < 195) { if(gx < 100) volMusic = Math.max(0, volMusic-0.1); else if(gx > 140) volMusic = Math.min(1, volMusic+0.1); }
    if (gy > 215 && gy < 240) { if(gx < 100) volSfx = Math.max(0, volSfx-0.1); else if(gx > 140) volSfx = Math.min(1, volSfx+0.1); }
    if (gy > 300) { state="MENU"; saveData(); }
  } else if (state === "SHOP") {
    if (previewItem) {
      if (gy > 230 && gy < 265) {
        if (SAVES.balloons.includes(previewItem.id)) { SAVES.equipped.balloon = previewItem.id; previewItem = null; }
        else if (SAVES.coins >= previewItem.price) { SAVES.coins -= previewItem.price; SAVES.balloons.push(previewItem.id); }
        saveData(); sfx("coin");
      } else if (gy > 280) previewItem = null;
    } else {
      if (gy > 320) state="MENU";
      else if (gy > 30 && gy < 55) shopTab = ["balloons", "skins", "skills"][Math.floor(gx/80)];
      else if (shopTab==="balloons") DB.balloons.forEach((it, i) => { if(gy > 70+i*42 && gy < 105+i*42) previewItem = it; });
    }
  } else if (state === "GAME") { gameStarted = true; player.vy = player.jf; sfx("jump"); }
  else if (state === "GAMEOVER") {
    if (gy > 200 && gy < 230) { player.reset(); state="GAME"; }
    else if (gy > 240 && gy < 270) state="MENU";
  }
}

window.addEventListener("mousedown", handleInput);
window.addEventListener("touchstart", handleInput, {passive:false});

function loop() {
  frames++;
  drawDerryCity(0.4);
  if (state === "GAME") {
    updateGame();
    entities.forEach(e => {
      if (e.type === "balloon") { ctx.fillStyle = e.color; ctx.beginPath(); ctx.ellipse(e.x+6, e.y+7, 6, 8, 0, 0, 7); ctx.fill(); }
      else { ctx.fillStyle = "#444"; ctx.fillRect(e.x, e.y, 18, 18); }
    });
    ctx.fillStyle = DB.balloons.find(b=>b.id===SAVES.equipped.balloon).color;
    ctx.beginPath(); ctx.ellipse(player.x+5, player.y-10, 6, 8, 0, 0, 7); ctx.fill();
    ctx.fillStyle = "#fff"; ctx.fillRect(player.x, player.y, 14, 22);
    ctx.font = "8px 'Press Start 2P'"; ctx.fillText(score, 10, 20);
  } else if (state === "MENU") {
    ctx.textAlign="center"; ctx.fillStyle="#f00"; ctx.fillText("VAMOS FLUTUAR", 120, 80);
    const btn = (t, y) => { ctx.fillStyle="#111"; ctx.fillRect(45, y, 150, 30); ctx.fillStyle="#fff"; ctx.fillText(t, 120, y+20); };
    btn(LANGS[currentLang].play, 160); btn(LANGS[currentLang].shop, 200); btn(LANGS[currentLang].settings, 240);
  } else if (state === "SETTINGS") {
    ctx.textAlign="center"; ctx.fillStyle="#fff"; ctx.fillText(LANGS[currentLang].settings, 120, 40);
    ctx.fillText("- " + LANGS[currentLang].music + " +", 120, 185); ctx.fillText("- " + LANGS[currentLang].sfx + " +", 120, 230);
    ctx.fillText(LANGS[currentLang].back, 120, 330);
  } else if (state === "SHOP") {
    ctx.textAlign="center"; ctx.fillText(shopTab, 120, 20);
    if(shopTab==="balloons") {
      DB.balloons.forEach((it, i) => { ctx.fillStyle="#111"; ctx.fillRect(10, 70+i*42, 220, 35); ctx.fillStyle="#fff"; ctx.fillText(it.id, 60, 92+i*42); });
    } else { ctx.fillText(LANGS[currentLang].soon, 120, 180); }
    ctx.fillText(LANGS[currentLang].back, 120, 345);
    if(previewItem) { ctx.fillStyle="#000"; ctx.fillRect(20,40,200,280); ctx.fillStyle="#fff"; ctx.fillText(previewItem.id, 120, 80); ctx.fillText(LANGS[currentLang].use, 120, 250); }
  } else if (state === "GAMEOVER") {
    ctx.textAlign="center"; ctx.fillStyle="red"; ctx.fillText(LANGS[currentLang].over, 120, 100);
    ctx.fillStyle="#111"; ctx.fillRect(45, 200, 150, 30); ctx.fillStyle="#fff"; ctx.fillText(LANGS[currentLang].retry, 120, 220);
    ctx.fillStyle="#111"; ctx.fillRect(45, 240, 150, 30); ctx.fillStyle="#fff"; ctx.fillText(LANGS[currentLang].menu, 120, 260);
  }
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
